<?php
//                      | |  | |  ____|  __ \|  \/  |  ____|/ ____|
//                      | |__| | |__  | |__) | \  / | |__  | (___  
//                      |  __  |  __| |  _  /| |\/| |  __|  \___ \ 
//                      | |  | | |____| | \ \| |  | | |____ ____) |
//                      |_|  |_|______|_|  \_\_|  |_|______|_____/
//````````````````````````````````````````````````````````````````````````````-```````````````````````
//```````````````````````````````````````````````````````````````````````````+d```````````````````````
//``````````````````````````````````````````````````````````````````````````:my```````````````````````
//`````````````````````````````````````````````````````````````````````````-mmy--:.``````````````./```
//````````````````````````````````````````````````````````````````````````/mmmmmmd:`````````````-hm```
//``````````````````````````````````````````````````````````````````````.smmmmmmy.`````````````-dmy```
//`````````````````````````````````````````````````````````````````````/mmmmmmmmd/```````````-smmd-```
//```````````````````````````````````````````````````````````````````:hmmmmmmmmmmh.```````./smmmy.````
//`````````````````````````````````````````````````````````````````-smmmmmmmmmmh/``````./sdmmmh/```.-`
//```````````````````````````````````````````````````````````````:smmmmmmmmmdo:`````./sdmmmms-````odh`
//````````````````````````````````````````````````````````````./hmNmmmmmmmy/.````./sdmmmmy/.```.+dmd/`
//`````````````````````````````````````````````````````````./ydmmmNmmmdyo.```.:+hdmmmmho-```./sdmmh:``
//```````````````````````````````````````````````````````:ohmmmNmmmmho.```-/odmmmmmds-.``-+sdmmmho.```
//````````````````````````````````````````````````````-+hmmNNmNmmy+-.`.:ohdmmmmmhs:.``-+hmmmmdy/.``..`
//`````````````````````````````````````````````````.+ymmNmmmdyo:.``-/ydmmmmmmho-.``-+hdmmmmy+.```-oh:`
//```````````````````````````````````````````````:sdmmmmdyo:.``./shdmmmmmdyo-.``-+hdmmmdy/.```-+ydy:``
//````````````````````````````````````````````:ohmmmyo:-.```-/ydmmmmmdyo:.```-/hdmmmho:.```:+hdds-````
//`````````````````````````````````````````./hmmmh+-`````:+hdmmmmdyo:.````-+ydmmmy+-.``-/yhmmh+.``````
//````````````````````````````````````````-hmmmy/.```./ohmmmmds/:.```.:+shdmdy+:.``-:shdmmdo:.````````
//````````````````````````````````````````dmmmy.```:sdmNmNmmmy::/+shhdmmhyo:.``.:ohdmmdho/.```````````
//```````````````````````````````````````-mmms```.ymNNmmmNmmNmmmmdhys+/-.``.:+sdmmmhy/..``````````````
//````````````````````````````````````````dmm/```hmNNNNNmNNNNNNmms/:-.-:/+ydmmdyo/-.````.:+o.`````````
//````````````````````````````````````````:mm:``-mNmmNNmNNNmNNmmmmmddddmmdhs+:.```.-:+syhs/.``````````
//`````````````````````````````````````````omo``-NmNNmmmNmmmmmmmmmmhso+/::::/+ooyhyhhs+:.`````````````
//``````````````````````````````````````````hd``.mmmmmmmmmmmmmmmmmmhooyhssssoo//:-...`````````````````
//``````````````````````````````````````````/m/``hmmNmmmmmmmmmmmmmmmmmmd/-.....---//.`````````````````
//```````````````````````````````````````````hy``ommNmmNmmmmmmmmmmmmmmhyssoooo+++/:-``````````````````
//```````````````````````````````````````````od``:mmmmmmmmmmmmmNNmmmmm/.``````````````````````````````
//```````````````````````````````````````````-m.`.mmmmmNNNmNmmmmmmmmmmmdhs//:---.`````````````````````
//```````````````````````````````````````````-m.``dmmmmNmNmmmmmmmmhyyyhhdddddhhyo:````````````````````
//```````````````````````````````````````````-h``.mmmmmmmmmNmmmmmm+````........```````````````````````
//````````````````````````````````````````````.``ommmmmmmdhhysyhddmyo/--.`````````````````````````````
//``````````````````````````````````````````````/mmmmdy+-.``````.-:/osysso-```````````````````````````
//`````````````````````````````````````````````+mmmmy-````------...```````````````````````````````````
//````````````````````````````````````````````/mmmmy``````ymdmddddhys+-.``````````````````````````````
//```````````````````````````````````````````/mmmmm/```````smmmmmmmmmmdh/`````````````````````````````
//`````````````````````````````````````````.smmmmmm/````````ommmmmmmmmmmm+````````````````````````````
//``````````````````````````````````+:````-hmmmmmmmy````:.```ymmmmmmmmmmmm+```````````````````````````
//````````````````````````````````-yd-```.dmmmmmmmmh````ss```-mmmmmmmmmmmmd```````````````````````````
//``````````````````````````````.odmh````/mmmmmmmds-```.ym.```mmmmmmmmmmmmm-``````````````````````````
//`````````````````````````````:hmmmd-```.ydddhs/-````.omh```-mmmmmmmmmmmmd.``````````````````````````
//```````````````````````````-ymmmmmmd+-.``...``````.:ymy.``.hmmmmmmmmmmmd/```````````````````````````
//```````````````````````````:dmmmmmmmmmhs+:---..::ohmm+```+dmmmmmmmmmmmd+````````````````````````````
//`````````````````````````````:smmmmmmmmmmmmmmmmmmmmmy```ommmmddhhys++:.```..:+/`````````````````````
//````````````````````````oy:````-hmmmmmmmmmmmmmmmmmmd-```++//:-.``````..:/ossoss`````````````````````
//```````````````````````:mmmy-```.ymmmmmmmmmmmddys+:.`````...---://+ooo+/-.``````````````````````````
//``````````````````````-dmmmmd+````smmmmmmmdy+-.``..:/+ssyyyyso+/:-.`````````````````````````````````
//`````````````````````-dmmmmmmmy````smmmmd+.``.-+shddyo+:-.``````````````````````````````````````````
//````````````````````.hmmmmmmmmmy```.dds:.``-+hdyo/-`````````````````````````````````````````````````
//````````````````````ymmmmmmmmmmm+```..``./ydy/.`````````````````````````````````````````````````````
//```````````````````smmmmmmmmmmmmy`````:sdh/.````````````````````````````````````````````````````````
//``````````````````smmmmmmmmmmmd+````/hdy:```````````````````````````````````````````````````````````
//````````````````.smmmmmmmmmmd+````:hmy-`````````````````````````````````````````````````````````````
//``````````````.+hmmmmmmmmmmo.```-ymy-```````````````````````````````````````````````````````````````
//`````````.-/oymmNmmmmmmmd+-```.omh/`````````````````````````````````````````````````````````````````
//``-:+osydmmmmmmmmmmmmho:`````/hh:```````````````````````````````````````````````````````````````````
//``dmmmmmmmmmmmdyys+:-`````-oys:`````````````````````````````````````````````````````````````````````
//```-:----:..````````.-+oss+-````````````````````````````````````````````````````````````````````````
//::---..-...-::/oosssso:.````````````````````````````````````````````````````````````````````````````
//-:://////+++/::-.```````````````````````````````````````````````````````````````````````````````````
//
//
//
// Author: OrangeCrush
// Date: 5/19/2012
//	Hermes is a robust error monitoring class as well as an SMTP interface
// Hermes focues on sending legitiment emails to warn you when your website
// has a fatal error or hits an execution branch that it shoudln't.
// A simple call to alert() will log the error and send an email
// with a dump of all variables decalred in the script when it was called.
//
// Dependencies:
// sendmail binary - sudo apt-get sendmail
// write access for log file. chown -R  www-data hermesRootdir (set in constructor)
//
// Examples:
// $hermes = new Hermes("myErrorEmail@gmail.com");
// ...
// mysql_connect(..) or $hermes->alert(get_defined_vars(), __FILE__, __LINE__, FALSE);
// Where TRUE will kill execution and FALSE will not.  Default is true.
// $hermes->log(sprintf("Coupon submitted with title of %s",$title))
//
// This module was written with PHP5+ in mind
// Version 1.4.1 (7/3/12)
// added logging capibilities
// added correct SMTP headers
//
// Planned improvements- 
// html support for email forms, driver class
//====================================================================

//====================================================================
//TODO LIST FOR USING HERMES
//Disable download of *.log files in .htaccess if not already there
//Pick a directory (that you have permissions to!) for hermes files
//	and set that in the constructor 
//Pick a default email in the constructor as well
//HACK THE PLANET!@
//====================================================================


class Hermes
{
	private $email, $exclude, $errors, $logDir, $loggingEnabled;
	function __construct($mailTo = "", $log = true)
	{
		$this->loggingEnabled = $log;
		if($mailTo == "")
			$this->email = "thor@SonOfOdin.com"; //TODO change your default email
		else
		{
			if(is_array($mailTo))
			{
				$this->email = array();
				for($i = 0; $i < count($mailTo); $i++)
				{
					$this->email[$i] = $mailTo[$i];
				}
			}
			else
				$this->email = $mailTo;
		}
		//Change this array to have different variables displayed.
		//default is that the only data that will be reported is data that
		//you create.  NEVER remove the GLOBALS. it has circular references
		//everywhere.  Will be worth your time to test this out to see
		//what you want.
		$this->exclude = array("GLOBALS", "_SERVER", "_POST", "_GET", "_FILES", 
			"_REQUEST", "_SESSION", "_ENV", "_COOKIE", "argc", "argv" );
		$this->errors = array();
		//TODO hermes logs dir-make sure your webserver has ownership.
		$this->logDir = "hermes";
		if($this->loggingEnabled) 
		{
			try {
				if(!is_dir($this->logDir))
					mkdir($this->logDir);
			}
			catch(exception $ex) { //privs or doesnt exist
				$this->loggingEnabled = false;	
			}
		}
	}
	

	//====================================================================
	// Header infomation for the SMTP protocol
	//====================================================================
	private function headers()
	{
		$host = $_SERVER["HTTP-HOST"] == null ? "gmail.com": $_SERVER["HTTP-HOST"];
		$headers = "From: Hermes <hermes@$host>\r\n";
		$headers .= "Reply-To: <hermes@$host>\r\n";
		$headers .= "X-Sender: <hermes@$host>\r\n";
		$headers .= "X-Mailer: PHP/".phpversion()."\r\n";
		$headers .= "X-Priority: 3\r\n";
		$headers .= "Return-Path: <hermes@$host>\r\n";
		$headers .= "MIME-Version: 1.0\r\n";
		return $headers;

	}

	//====================================================================
	// Sends the email. ONLY public method you will need to call.
	// ex:  errorH->alert(get_defined_vars(), __FILE__,__LINE__);
	// day has 86400 seconds (default)
	// week has 604800
	// hour 3600
	//====================================================================
	public function alert($dumpedVals, $file, $line, $die = TRUE)
	{
		try 
		{ 
			$this->readErrors();
			if(!$this->beenSent(md5($file.$line),86400))
			{
				$msg =  "Error report generated on: ".Date("m/d/Y")."\n";
				$msg = $msg."In File: ".$file." at line: ".$line. ".\n";
				$msg = $msg.$this->parseVars($dumpedVals);
				if(!is_array($this->email))
					mail($this->email,"Hermes has delivered an error message" ,$msg, $this->headers());
				else
					foreach($this->email as $index => $email)
						mail($email,"Hermes has delivered an error message" ,$msg,$this->headers());
				unset($this->errors[md5($file,$line)]); //meh
				$this->logError($file, $line);
				$this->log("Alert called in file $file at line $line");
			}
		}
		catch(exception $ex){;}//always test if you are getting emails
			if($die) {die();}
	}

	//====================================================================
	// Filters data out from the excludes array, and does not dump info
	// from this class.
	//====================================================================
	private function cleanData($key, $val)
	{
		if($val instanceof Hermes)
		{
			return FALSE;
		}
		foreach($this->exclude as $index => $val)
		{
			if($key == $val && !is_numeric($key))
			{
				return FALSE;
			}
		}
		return TRUE;
	}

	//====================================================================
	// The masterpiece.  Parses the array of all variables in the page
	// that faulted. As of now, Circular references will crash your server.
	// ie circular linked list
	//====================================================================
	private function parseVars($vals, $tab ="")//optional recursive values for output
	{
		$rval = "";
		foreach($vals as $key => $val)
		{
			if( $this->cleanData($key, $val))
			{
				if(is_object($val))
				{
					$rval = $rval.$tab."Object: ".$key." of type: ".get_class($val)."\n";
					$rval = $rval.$tab."{\n";
					$newAry = get_object_vars($val);
					$rval = $rval.$this->parseVars($newAry, $tab."   ");
					$rval = $rval.$tab."}\n";
				}
				elseif(is_array($val))
				{
					$rval = $rval.$tab."Array: ".$key."\n";
					$rval = $rval.$tab."{\n";
					$rval = $rval.$this->parseVars($val, $tab."   ");
					$rval = $rval.$tab."}\n";
				}
				else
				{
					if($val != "")
						$rval= $rval.$tab.$key." = ".$val."\n";
					else
						$rval= $rval.$tab.$key." = NULL\n";
				}
			}
		}
		return $rval;
	}


	//====================================================================
	// Writes an error to file so that the error is not reported over and over
	// Overwirtes file each time.
	//====================================================================
	private function logError($file, $line)
	{
		$this->errors[md5($file.$line)] = time();
		$fh = fopen($this->logdir."hermes.log", "w");
		if($fh == FALSE)
			return;
		if(flock($fh, LOCK_EX)) //lock file to be safe. may be atomic sometimes. idk 
		{
			flock($fh, LOCK_EX);
			fseek($fh, 0 ,SEEK_END);
			foreach($this->errors as $key => $val)
			{
				fputs($fh, $key.' '.$val."\n");
			}
			flock($fh, LOCK_UN);
		}
		fclose($fh);
	}

	//====================================================================
	// Reads hermes.log and reads it into the errors array.
	//====================================================================
	private function readErrors()
	{
		$fh = fopen($this->logdir."hermes.log", "r");
		if($fh == FALSE)
			return;
		if(flock($fh, LOCK_EX))
		{
			$line = fgets($fh);
			while($line != FALSE)
			{
				$pair = split(' ', $line);
				$this->errors[$pair[0]] = $pair[1]; //undefined offset whatever lol
				$line = fgets($fh);
			}
			flock($fh, LOCK_UN);
		}
		fclose($fh);
	}

	//====================================================================
	// Checks if an error message was already sent since the given
	// time period in seconds.
	//====================================================================
	private function beenSent($hash, $time)
	{
		foreach($this->errors as $key => $val)
		{
			if($key == $hash && $val + $time > time())
				return TRUE;
		}
		return FALSE;
	}

	//====================================================================
	// Sends a notification with a message of info.
	//====================================================================
	public function notify($sub,$msg)
	{
		if(!is_array($this->email))
			mail($this->email, $sub, $msg, $this->headers());
		else
			foreach($this->email as $index => $email)
				mail($email, $sub, $msg, $this->headers());
	}


	//====================================================================
	// Logs $info to file.  uses a day by day basis for log files.
	// file structure as set up in constrcutor:
	// webroot/
	// 	 hermes/
	// 	   hermes.log (for emails and not duplicate sending)
	//     dM_Y/
	//     dM_Y/
	//     .....
	//       dM.log
	//       	[H:i info file line]:
	//====================================================================
	public function log($info, $file ="", $line = "")
	{
		if($this->loggingEnabled)
		{
			try 
			{
				$dirpath = $this->logDir."/".date("M_Y");
				$filepath = $dirpath."/".date("d_M_Y").".log";
				$header = "[".date("H:i");//   ."]:   ";
				$header = $file == "" && $line == "" ? $header."]:  " : $header." in $file at $line]: ";
				if(!is_dir($dirpath))
					mkdir($dirpath);
				$fh = fopen($filepath,"a");	
				fwrite($fh,$header.$info."\n");
			}
			catch(exception $ex) {} //check perms
		}
	}	


}//Hermes
?>
